<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <style>
	
		@import url('https://fonts.googleapis.com/css?family=Kanit:200|Ubuntu|Kalam');

		html, body {
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		h1 {
			margin: 0;
			padding: 20px 30px;
			text-align: left;
			font-size: 4em;
			background-color: #4257b2;
			font-family: 'Kalam', cursive;
			color: #89f9ea;
		}
		
		h3{
			padding: 0;
			margin-top: 0;
			font-weight: bolder;
		}

		#content {
			font-size: 1.5em;
			text-align: center;
			height: 95%;
			background-color: #f0f0f0;
			overflow: scroll;
			overflow-x: hidden;
		}
		
		#actionSection{
			margin: 0;
			margin-top: 10px;
			padding: 0;
			width: 400px;
			height: 100%;
			float: left;
			color: #444;
			font-family: 'Kanit', sans-serif;
		}

		#addSection{
			padding: 40px 40px 50px 20px;
		}

		#searchSection{
			padding: 40px 40px 40px 20px;
		}
		
		#searchSection form{
			text-align: center;
		}
		
		#questionField{
			width: 100%;
			font-size:14pt; 
			padding: 2px 3px;
			margin: 8px 0;
		}
		
		#answerField{
			width: 100%;
			font-size:14pt; 
			padding: 2px 3px;
			margin: 8px 0;
			height: 30pt;
		}
		
		#subjectField, #topicField{
			width: 100px;
			padding-left: 5px;
			font-family: 'Ubuntu', sans-serif;
			font-size: 12pt;
		}
		
		form{
			padding: 10px;
		}
		
		.card{
			width: 70%;
			height: 60%;
			border-radius: 5px;
			text-align: center;
			margin: 0 auto;
			margin-top: 10%;
			display: flex;
    	align-items: center;
			font-family: 'Ubuntu', sans-serif;
		}
	
		.front, .back{
			width: 100%;
			height: 100%;
			background-color: white;
			border-radius: 5px;

		}
	
		.cardContent{
			margin: 0;
			padding: 0;
			text-align: center;
			margin-top: 20%
		}
		
		label{
			font-weight: bolder;
		}
		
		p{
			word-wrap: break-word;
		}
		
		.topicId{
			float: left;
			vertical-align: top;
			font-size: 12pt;
			padding: 15px;
		}
		
		hr{
			width: 70%;
			background-color: transparent;
			border-top: 2px dashed #8c8b8b;
		}
		
		#addButton{
			width: 60pt;
			height: 2.4em;
			border-radius: 3pt;
			font-family: 'Montserrat', sans-serif;
			border: 0;
			color: white;
			background-color: #fa7a64;
			float: right;
			margin-right: -8px;
		}
		
		#searchButton{
			width: 60pt;
			height: 2.4em;
			border-radius: 3pt;
			font-family: 'Montserrat', sans-serif;
			border: 0;
			color: white;
			background-color: #fa7a64;
		}
		
		select{
			height: 2em;
		}
		
	</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<!--	https://nnattawat.github.io/flip/-->
	<script src="https://cdn.rawgit.com/nnattawat/flip/master/dist/jquery.flip.min.js"></script>
	
	<script>
			$(document).ready(function() {
				//find all divs with an attribute name that starts with "card"
				$("div[id^=card").flip({axis: 'y'});
			});
	</script>
  <script type="text/babel">
		const handleResponse = (xhr) => {

			const content = document.querySelector(`#content`);

			switch(xhr.status){
				case 200: //success in getting
					displayCards(content,xhr);
					break;
				case 201: //sucess in creating
					createCard(content, xhr);
					break;
				case 204: //updated
					content.innerHTML = '<h1>Updated</h1>';
					break;
				case 400: //bad request
					content.innerHTML = '<h1>Bad Request</h1>';
					break;
				default:
					content.innerHTML = `<h1>Resource Not Found</h1>`;
					break;
			}
		};

		const addCard = (e, addForm) =>{

			//grab the forms action (url to go to)
			//and method (HTTP method - POST in this case)
			const action = addForm.getAttribute('action');
			const method = addForm.getAttribute('method');

			//grab the form's name and age fields so we can check user input
			const topicField = addForm.querySelector('#topicField');
			const questionField = addForm.querySelector('#questionField');
			const answerField = addForm.querySelector('#answerField');

			const xhr = new XMLHttpRequest();

			xhr.open(method, action);
			xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			xhr.setRequestHeader('Accept', 'application/json');

			//if get request or head request
			if(method == 'post') {
				//set onload to parse request and get json message
				xhr.onload = () => handleResponse(xhr);
			} 

			//build our x-www-form-urlencoded format
			const formData = `topic=${topicField.value}&question=${questionField.value}&answer=${answerField.value}`;

			xhr.send(formData);

			//cancel browser's default action
			e.preventDefault();
			//return false to prevent page redirection from a form
			return false;
		};


		const createCard = (content, xhr) =>{

			const obj = JSON.parse(xhr.response);

			if(Object.keys(obj.cards)){

				var html= "";

				//last card in object
				var cardName= Object.keys(obj.cards)[Object.keys(obj.cards).length-1];
				var card = obj.cards[cardName];
				console.log(obj.cards);

				createTemplate(4, cardName, card.question, card.answer);
			}
		};

		const getCards = (e, searchForm) =>{

			//grab the forms action (url to go to)
			//and method (HTTP method - POST in this case)
			const action = searchForm.getAttribute('action');
			const method = searchForm.getAttribute('method');

			const xhr = new XMLHttpRequest();

			xhr.open(method, action);
			xhr.setRequestHeader('Accept', 'application/json');

			//if get request or head request
			if(method == 'get') {
				//set onload to parse request and get json message
				xhr.onload = () => handleResponse(xhr);
			}

			//cancel browser's default action
			e.preventDefault();
			//return false to prevent page redirection from a form
			return false;
		};

		const displayCards= (content,xhr) =>{
			const obj = JSON.parse(xhr.response);

			//grab the form's name and age fields so we can check user input
			const subjectField = addForm.querySelector('#subjectField');

			if(obj.cards.length >0){ //if card obj list is not empty

				//clear content
				content.innerHTML = "";

				for(var i=0; i<obj.cards.length; i++){

					var card = obj[cards[i]]; //get card object at index

					//if topic is all
					if(subjectField.value === 'All'){
								createTemplate(i, card.topic, card.question, card.answer);
						}
					else{
							//if card topic matches with the search topic
							if(obj[cards[i]].topic === subjectField.value){
								//send only the filtered topic
								createTemplate(i, card.topic, card.question, card.answer);
							}
					}
				}
			}
		};

		const createTemplate = (num,topic, question, answer) =>{
			var html= "";

			//do some concatenation
			html+="<div class='card' id='card-" + num + "'>"; //card number

			html+="<div class='front'>";
			html+="<div class= 'topicId'>Topic: "+ topic + "</div>"; //card topic
			html+="<div class='cardContent'>";
			html+="<p><strong>Q:</strong>" + question + "</p>";
			html+= "</div>";
			html+= "</div>";

			html+="<div class='back'>";
			html+="<div class= 'topicId'>Topic: "+ topic + "</div>"; //card topic
			html+="<div class='cardContent'>";
			html+="<p><strong>A:</strong>" + answer + "</p>";
			html+= "</div>";
			html+= "</div>";

			html+= "</div>";
				
				

			content.innerHTML +=html;
		}

		const init = () => {
			//grab form
			const addForm = document.querySelector('#addForm');
			const searchForm = document.querySelector('#searchForm');

			addForm.addEventListener('submit', (e) => {
				addCard(e, addForm);
			});

			searchForm.addEventListener('submit', (e) => {
				getCards(e,searchForm);
			});
		};

		window.onload = init;

  </script>
</head>
	
<body>
	<h1>Flashcards</h1>
	<section id= "actionSection">
		
		<section id= "addSection"> 
			<h3>Add a Card:</h3>
			<form id="addForm" action="/addCard" method="post">
				<label for="topic">Topic: </label>
				<select id='topicField'>
					<option value='math'>Math</option>
					<option value='english'>English</option>
					<option value='history'>History</option>
					<option value='science'>Science</option>
					<option value='language'>Language</option>
				</select>
				<br> <br>
				<label for="question">Question: </label>
				<br>
				<input id="questionField" type="text" name="question" /> 
				<br>
				<label for="answer">Answer: </label>
				<br>
				<input id="answerField" type="text" name="answer" min="0" max="1000"/> <br>
				<input id= "addButton" type="submit" value="Add Card" />
			</form>
		</section>
		<hr/>
		<section id= "searchSection"> 
			<h3>Search Cards By:</h3>
			<form id="searchForm" action="/searchCards" method="get">
				<label for="topic">Topic: </label>
				<select id='subjectField'>
					<option value='all'>All</option>
					<option value='math'>Math</option>
					<option value='english'>English</option>
					<option value='history'>History</option>
					<option value='science'>Science</option>
					<option value='language'>Language</option>
				</select>
				<input id= "searchButton" type="submit" value="Search" />
			</form>
		</section>
	</section>
  
  <section id="content">
		<div class="card" id="card-1"> 
			<div class="front"> 
				<div class= "topicId">Topic: </div>
				<div class="cardContent"> 
					<p><strong>Q:</strong>question</p>
				</div>
			</div> 
			<div class="back">
				<div class= "topicId">Topic:</div>
				<div class="cardContent">
					<p><strong>A:</strong>anwer</p>
				</div>
			</div> 
		</div>

  </section>
</body>
</html>